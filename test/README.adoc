= REST API Testing Guide
:toc: left
:icons: font
:source-highlighter: highlightjs

== Overview

This directory contains comprehensive testing resources for the Spring Load Development API services. It includes:

* HTTP request files for testing API endpoints using VS Code's REST Client extension
* A shell script for automated test data loading
* Configuration files for environment variables

The test files cover authentication and full CRUD operations for all API services including rifles, loads, groups, shots, and components (cases, propellants, primers, projectiles).

Configuration values (ports, Keycloak realm, OTEL endpoint) originate from the shared config repository `spring-load-development-config`. If you modify any of the YAML files there (e.g. `api-gateway.yml`), refresh your locally running services or re-run docker-compose to pick up changes.

=== Data shapes used in requests

All quantity-like values use JSR-385 (Units of Measurement) with a consistent JSON shape:

* Quantity: {"value": number, "unit": string, "scale": "ABSOLUTE" | "RELATIVE"}
    - Examples:
        - Bullet weight: {"value": 140, "unit": "[gr]", "scale": "ABSOLUTE"}
        - Range: {"value": 100, "unit": "[yd_i]", "scale": "ABSOLUTE"}
        - Velocity: {"value": 2800, "unit": "[ft_i]/s", "scale": "ABSOLUTE"}
    * HTTP request files for testing API endpoints using VS Code's REST Client extension
    * A shell script for automated test data loading
    * Configuration files for environment variables
    * Full-text search examples for component resources (cases, propellants, primers, projectiles)
* MonetaryAmount: {"amount": number, "currency": "ISO-4217 code"}
    - Example: {"amount": 89.99, "currency": "CAD"}
    The test files cover authentication and full CRUD operations for all API services including rifles, loads, groups, shots, and components (cases, propellants, primers, projectiles), plus search endpoints.

Notes:
* The scale field is optional and defaults to ABSOLUTE when omitted.
* Units use UCUM formatting (e.g., "[in_i]", "mm", "m/s").
* Dimensionless quantities (counts) must use the UCUM symbol "1" rather than descriptive words like "one". Example: {"value": 100, "unit": "1"}
* For mass in imperial units, use UCUM avoirdupois symbols: pounds "[lb_av]", ounces "[oz_av]", grains "[gr]".

== Prerequisites
* Running local stack (Docker Compose or manual) including:
** Keycloak (auth) – realm `reloading`, user `reloader1`
** API Gateway (`localhost:8080`)
** Loads, Rifles, Components services behind gateway
** PostgreSQL with required schemas
* Bash shell (Linux/macOS/WSL)
* `curl` command-line tool
* VS Code REST Client extension (recommended)
* CRUD and search endpoints implemented for components:
** Cases: `/api/cases`, search `/api/cases/search?query=Lapua`
** Propellants: `/api/propellants`
** Primers: `/api/primers`
** Projectiles: `/api/projectiles`

NOTE: Load validation requires at least one of `distanceFromLands` or `caseOverallLength`. The sample data loader sets both plus `neckTension`.

== Required Running Services

* PostgreSQL database (default: localhost:5432)
* Discovery server (default: localhost:8761) – for service registration in non-K8s local dev
* API Gateway (default: localhost:8080)
* Rifles service (through gateway)
* Loads service (through gateway)
* Components service (through gateway)
* (Optional) MCP Server

== Configuration

The environment configuration is stored in `http-client.env.json`. It includes:

* Keycloak authorization server settings
* Client credentials
* Test user credentials

== Available Test Files

=== HTTP Request Files

==== rifles-service.http

Contains requests for testing the Rifles API endpoints:

* Authentication with Keycloak
* CRUD operations for rifles

==== loads-service.http

Containing requests for testing Loads, Groups, and Shots API endpoints:

* Authentication with Keycloak
* Loads: CRUD operations for loads, load statistics
* Groups: CRUD operations for groups, group statistics
* Shots: CRUD operations for shots
* All tests use JSR-385 Quantity types with proper units (imperial and metric)
* Workflow-based organization: Loads → Groups → Shots

==== components-service.http

Contains requests for testing the Components API endpoints:

* Authentication with Keycloak
* CRUD operations for cases, propellants, primers, and projectiles
  - Cases: create, get, update, delete, search
  - Propellants: create, get, update, delete, search
  - Primers: create, get, update, delete, search
  - Projectiles: create, get, update, delete, search

=== Configuration Files

==== http-client.env.json

Environment configuration file containing:

* Keycloak authorization server settings
* Client credentials
* Test user credentials

=== Automated Data Loading

==== load_test_data.sh

A bash script that automatically loads test data into the system via REST API calls using the JSON shapes above. This script:

* Authenticates with Keycloak to obtain access tokens
* Creates a test rifle (Tikka T3x CTR)
* Creates a load development dataset with multiple powder charges (using [gr])
* Creates shooting groups with group size ([in_i]), range ([yd_i]), and velocities ([ft_i]/s)
* Provides comprehensive error handling and colored output
* Validates that all required services are running before execution

To run the script:

[source,bash]
----
cd spring-load-development/test
chmod +x load_test_data.sh
./load_test_data.sh
----

The script requires the same configuration as the HTTP files and will use the `http-client.env.json` file for authentication settings.

== How to Use

=== Using HTTP Request Files

1. Open any `.http` file in VS Code
2. You'll see clickable `Send Request` links above each request
3. Select the environment from the bottom status bar (default: "local")
4. Click `Send Request` to execute

TIP: Requests that require authentication will automatically use the token from the "Authenticate" request.

=== Using the Automated Data Loader

1. Ensure all required services are running
2. Navigate to the test directory: `cd spring-load-development/test`
3. Make the script executable: `chmod +x load_test_data.sh`
4. Run the script: `./load_test_data.sh`

The script will:

* Verify all dependencies are available
* Load configuration from `http-client.env.json`
* Check that services are accessible
* Authenticate with Keycloak
* Create test data including rifles, loads, groups, and shots
* Provide a summary of created entities

== Request Flow

1. First, run the "Authenticate" request to get an access token
2. The token is automatically used in subsequent requests
3. Test individual endpoints as needed

[source,mermaid]
....
flowchart LR
    KC[Keycloak] -->|Token| Client[REST Client]
    Client -->|Bearer| APIGW[API Gateway]
    APIGW --> Loads[Loads]
    APIGW --> Rifles[Rifles]
    APIGW --> Components[Components]
    APIGW --> MCP[MCP Server]
    Components -->|Search| Components
    classDef auth fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef gw fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef svc fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
    classDef client fill:#e1f5fe,stroke:#0277bd,stroke-width:2px
    class KC auth
    class APIGW gw
    class Loads,Rifles,Components,MCP svc
    class Client client
....

== VS Code Settings Configuration

To make the environment variables available globally in VS Code:

1. Open VS Code Settings (File > Preferences > Settings or `Ctrl+,`)
2. Click on the "Open Settings (JSON)" icon in the top-right corner
3. Add the following configuration:

[source,json]
----
{
    "rest-client.environmentVariables": {
        "$shared": {
            // Shared variables across all environments
        },
        "local": {
            "authorization_host": "http://localhost:7080",
            "realm": "reloading",
            "client_id": "reloading-client",
            "client_secret": "2EvQuluZfxaaRms8V4NhzBDWzVCSXtty",
            "username": "reloader1",
            "password": "reloader1"
        }
    }
}
----

TIP: This allows you to use these variables in any `.http` file across your workspace.

== Tips

=== HTTP Request Testing

* Use the response of one request in another with the syntax `{{RequestName.response.body.field}}`
* Headers can be modified directly in the `.http` files
* Add new environments by creating new objects in `http-client.env.json`
* You can chain requests using dynamic variables (e.g., use IDs from previous responses in subsequent requests)
* The `.http` files are updated as new endpoints or changes are introduced in the API

=== Automated Testing

* Run `load_test_data.sh` to quickly populate the system with test data
* The script validates services are running before attempting to load data
* Check the script output for any errors or issues during data loading
* Use the created test data IDs in your HTTP request files for further testing

=== Troubleshooting

* Ensure all services are running before testing
* Verify Keycloak is properly configured with the reloading realm
* Check that the client credentials in `http-client.env.json` are correct
* If authentication fails, verify the user `reloader1` exists in Keycloak
