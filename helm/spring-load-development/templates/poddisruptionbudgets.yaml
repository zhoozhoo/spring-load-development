{{- if .Values.podDisruptionBudget.enabled }}
---
# PostgreSQL PDB
{{- if .Values.postgresql.enabled }}
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: postgres-pdb
  namespace: {{ .Values.postgresql.namespace }}
  labels:
    app: postgres
    {{- include "spring-load-development.labels" . | nindent 4 }}
spec:
  minAvailable: {{ .Values.podDisruptionBudget.postgresql.minAvailable | default 1 }}
  selector:
    matchLabels:
      app: postgres
{{- end }}
---
# Keycloak PostgreSQL PDB
{{- if .Values.keycloakPostgresql.enabled }}
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: keycloak-postgres-pdb
  namespace: {{ .Values.keycloakPostgresql.namespace }}
  labels:
    app: keycloak-postgres
    {{- include "spring-load-development.labels" . | nindent 4 }}
spec:
  minAvailable: {{ .Values.podDisruptionBudget.keycloakPostgresql.minAvailable | default 1 }}
  selector:
    matchLabels:
      app: keycloak-postgres
{{- end }}
---
# Keycloak PDB
{{- if .Values.keycloak.enabled }}
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: keycloak-pdb
  namespace: {{ .Values.keycloak.namespace }}
  labels:
    app: keycloak
    {{- include "spring-load-development.labels" . | nindent 4 }}
spec:
  minAvailable: {{ .Values.podDisruptionBudget.keycloak.minAvailable | default 1 }}
  selector:
    matchLabels:
      app: keycloak
{{- end }}
---
# API Gateway PDB
{{- if .Values.apiGateway.enabled }}
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ include "spring-load-development.fullname" . }}-api-gateway-pdb
  namespace: {{ .Values.microservices.namespace }}
  labels:
    {{- include "spring-load-development.microservice.labels" (dict "componentName" "api-gateway" "context" .) | nindent 4 }}
spec:
  {{- if .Values.apiGateway.podDisruptionBudget.minAvailable }}
  minAvailable: {{ .Values.apiGateway.podDisruptionBudget.minAvailable }}
  {{- else }}
  maxUnavailable: {{ .Values.apiGateway.podDisruptionBudget.maxUnavailable | default 1 }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "spring-load-development.microservice.selectorLabels" (dict "componentName" "api-gateway" "context" .) | nindent 6 }}
{{- end }}
---
# Loads Service PDB
{{- if .Values.loadsService.enabled }}
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ include "spring-load-development.fullname" . }}-loads-service-pdb
  namespace: {{ .Values.microservices.namespace }}
  labels:
    {{- include "spring-load-development.microservice.labels" (dict "componentName" "loads-service" "context" .) | nindent 4 }}
spec:
  {{- if .Values.loadsService.podDisruptionBudget.minAvailable }}
  minAvailable: {{ .Values.loadsService.podDisruptionBudget.minAvailable }}
  {{- else }}
  maxUnavailable: {{ .Values.loadsService.podDisruptionBudget.maxUnavailable | default 1 }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "spring-load-development.microservice.selectorLabels" (dict "componentName" "loads-service" "context" .) | nindent 6 }}
{{- end }}
---
# Components Service PDB
{{- if .Values.componentsService.enabled }}
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ include "spring-load-development.fullname" . }}-components-service-pdb
  namespace: {{ .Values.microservices.namespace }}
  labels:
    {{- include "spring-load-development.microservice.labels" (dict "componentName" "components-service" "context" .) | nindent 4 }}
spec:
  {{- if .Values.componentsService.podDisruptionBudget.minAvailable }}
  minAvailable: {{ .Values.componentsService.podDisruptionBudget.minAvailable }}
  {{- else }}
  maxUnavailable: {{ .Values.componentsService.podDisruptionBudget.maxUnavailable | default 1 }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "spring-load-development.microservice.selectorLabels" (dict "componentName" "components-service" "context" .) | nindent 6 }}
{{- end }}
---
# Rifles Service PDB
{{- if .Values.riflesService.enabled }}
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ include "spring-load-development.fullname" . }}-rifles-service-pdb
  namespace: {{ .Values.microservices.namespace }}
  labels:
    {{- include "spring-load-development.microservice.labels" (dict "componentName" "rifles-service" "context" .) | nindent 4 }}
spec:
  {{- if .Values.riflesService.podDisruptionBudget.minAvailable }}
  minAvailable: {{ .Values.riflesService.podDisruptionBudget.minAvailable }}
  {{- else }}
  maxUnavailable: {{ .Values.riflesService.podDisruptionBudget.maxUnavailable | default 1 }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "spring-load-development.microservice.selectorLabels" (dict "componentName" "rifles-service" "context" .) | nindent 6 }}
{{- end }}
---
# MCP Server PDB
{{- if .Values.mcpServer.enabled }}
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ include "spring-load-development.fullname" . }}-mcp-server-pdb
  namespace: {{ .Values.microservices.namespace }}
  labels:
    {{- include "spring-load-development.microservice.labels" (dict "componentName" "mcp-server" "context" .) | nindent 4 }}
spec:
  {{- if .Values.mcpServer.podDisruptionBudget.minAvailable }}
  minAvailable: {{ .Values.mcpServer.podDisruptionBudget.minAvailable }}
  {{- else }}
  maxUnavailable: {{ .Values.mcpServer.podDisruptionBudget.maxUnavailable | default 1 }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "spring-load-development.microservice.selectorLabels" (dict "componentName" "mcp-server" "context" .) | nindent 6 }}
{{- end }}
---
# Observability Stack PDBs
{{- if .Values.observability.enabled }}
# Grafana PDB
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: grafana-pdb
  namespace: {{ .Values.observability.namespace }}
  labels:
    app: grafana
    {{- include "spring-load-development.labels" . | nindent 4 }}
spec:
  minAvailable: {{ .Values.podDisruptionBudget.observability.grafana.minAvailable | default 1 }}
  selector:
    matchLabels:
      app: grafana
---
# Prometheus PDB
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: prometheus-pdb
  namespace: {{ .Values.observability.namespace }}
  labels:
    app: prometheus
    {{- include "spring-load-development.labels" . | nindent 4 }}
spec:
  minAvailable: {{ .Values.podDisruptionBudget.observability.prometheus.minAvailable | default 1 }}
  selector:
    matchLabels:
      app: prometheus
---
# Loki PDB
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: loki-pdb
  namespace: {{ .Values.observability.namespace }}
  labels:
    app: loki
    {{- include "spring-load-development.labels" . | nindent 4 }}
spec:
  minAvailable: {{ .Values.podDisruptionBudget.observability.loki.minAvailable | default 1 }}
  selector:
    matchLabels:
      app: loki
---
# Tempo PDB
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: tempo-pdb
  namespace: {{ .Values.observability.namespace }}
  labels:
    app: tempo
    {{- include "spring-load-development.labels" . | nindent 4 }}
spec:
  minAvailable: {{ .Values.podDisruptionBudget.observability.tempo.minAvailable | default 1 }}
  selector:
    matchLabels:
      app: tempo
---
# OpenTelemetry Collector PDB
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: otel-collector-pdb
  namespace: {{ .Values.observability.namespace }}
  labels:
    app: otel-collector
    {{- include "spring-load-development.labels" . | nindent 4 }}
spec:
  minAvailable: {{ .Values.podDisruptionBudget.observability.otelCollector.minAvailable | default 1 }}
  selector:
    matchLabels:
      app: otel-collector
{{- end }}
{{- end }}
